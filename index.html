<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAK Variety Store</title>
    <!-- Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-slate-900 text-slate-100;
        }
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 2rem;
            background-color: #22c55e;
            color: white;
            border-radius: 9999px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: opacity 0.5s ease-in-out;
            opacity: 0;
            pointer-events: none;
            z-index: 1000;
        }
        .product-card {
            @apply bg-slate-800 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            @apply bg-slate-800 p-8 rounded-xl shadow-lg w-11/12 md:w-1/2 lg:w-1/3;
        }
        .cart-modal-content {
            @apply bg-slate-800 p-6 rounded-xl shadow-lg w-11/12 md:w-3/4 lg:w-1/2 overflow-y-auto max-h-screen;
        }
        .orders-modal-content {
            @apply bg-slate-800 p-6 rounded-xl shadow-lg w-11/12 md:w-3/4 lg:w-1/2 overflow-y-auto max-h-screen;
        }
        .product-details-modal-content {
            @apply bg-slate-800 p-8 rounded-xl shadow-lg w-11/12 md:w-2/3 lg:w-1/2;
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="bg-slate-900 shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex items-center justify-between">
            <a href="#" class="text-2xl font-bold text-teal-400">PAK Variety Store</a>
            <nav class="hidden md:flex space-x-6 text-slate-300">
                <a href="#clothes" class="hover:text-teal-400">Clothes</a>
                <a href="#shoes" class="hover:text-teal-400">Shoes</a>
                <a href="#electronics" class="hover:text-teal-400">Electronics</a>
                <a href="#" class="hover:text-teal-400">New Arrivals</a>
                <a href="#" class="hover:text-teal-400">Contact</a>
            </nav>
            <div class="flex items-center space-x-4">
                <button id="view-orders-toggle" class="relative bg-slate-800 text-slate-300 py-2 px-4 rounded-full hover:bg-slate-700 transition duration-300 text-sm">
                    My Orders
                </button>
                <button id="cart-toggle" class="relative bg-slate-800 text-slate-300 py-2 px-4 rounded-full hover:bg-slate-700 transition duration-300 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-1">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c1.533 0 2.847-1.18 3.006-2.671L20.5 7.5a2.25 2.25 0 00-2.25-2.25H6.375a2.25 2.25 0 00-2.244 2.158.428.428 0 00.088.085l.895.945c.44.463 1.01.693 1.62.693H19.5" />
                    </svg>
                    <span id="cart-count">0</span>
                </button>
                <button id="admin-toggle" class="bg-slate-800 text-slate-300 font-semibold py-2 px-4 rounded-full hover:bg-slate-700 transition duration-300 text-sm">
                    Admin Panel
                </button>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="bg-gradient-to-r from-slate-800 to-slate-900 py-16 md:py-24 text-center">
        <div class="container mx-auto px-6">
            <h1 class="text-4xl md:text-6xl font-extrabold text-teal-400 mb-4">
                Redefine Your Wardrobe
            </h1>
            <p class="text-lg md:text-xl text-slate-300 mb-8 max-w-2xl mx-auto">
                Discover the latest trends in clothes, shoes, and electronics, curated for style, quality, and individuality.
            </p>
            <a href="#products" class="bg-teal-500 text-white font-semibold py-3 px-8 rounded-full shadow-lg hover:bg-teal-400 transition duration-300">
                Shop Now
            </a>
        </div>
    </section>

    <!-- Admin Panel Section (hidden by default) -->
    <section id="admin-panel" class="hidden bg-slate-800 py-12 px-6">
        <div class="container mx-auto max-w-2xl bg-slate-900 p-8 rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold text-teal-400 mb-6 text-center">Admin Panel</h2>
            <form id="add-product-form" class="space-y-6">
                <div>
                    <label for="product-name" class="block text-sm font-medium text-slate-300">Product Name</label>
                    <input type="text" id="product-name" required class="mt-1 block w-full rounded-md border-slate-700 shadow-sm focus:border-teal-500 focus:ring-teal-500 bg-slate-700 text-slate-200">
                </div>
                <div>
                    <label for="product-price" class="block text-sm font-medium text-slate-300">Product Price ($)</label>
                    <input type="number" id="product-price" step="0.01" required class="mt-1 block w-full rounded-md border-slate-700 shadow-sm focus:border-teal-500 focus:ring-teal-500 bg-slate-700 text-slate-200">
                </div>
                <div>
                    <label for="product-image" class="block text-sm font-medium text-slate-300">Image URL</label>
                    <input type="url" id="product-image" required class="mt-1 block w-full rounded-md border-slate-700 shadow-sm focus:border-teal-500 focus:ring-teal-500 bg-slate-700 text-slate-200">
                </div>
                <div>
                    <label for="product-category" class="block text-sm font-medium text-slate-300">Category</label>
                    <select id="product-category" required class="mt-1 block w-full rounded-md border-slate-700 shadow-sm focus:border-teal-500 focus:ring-teal-500 bg-slate-700 text-slate-200">
                        <option value="clothes">Clothes</option>
                        <option value="shoes">Shoes</option>
                        <option value="electronics">Electronics</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-teal-500 text-white font-semibold py-3 px-8 rounded-full hover:bg-teal-400 transition duration-300">
                    Add Product
                </button>
            </form>
        </div>
    </section>

    <!-- Product Sections -->
    <main id="products" class="container mx-auto px-6 py-16">
        <!-- Clothes Section -->
        <section id="clothes" class="mb-16">
            <h2 class="text-3xl md:text-4xl font-bold text-teal-400 mb-8 text-center">
                Our Clothing Collection
            </h2>
            <div id="clothes-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                <!-- Products will be dynamically loaded here -->
            </div>
        </section>

        <!-- Shoes Section -->
        <section id="shoes" class="mb-16">
            <h2 class="text-3xl md:text-4xl font-bold text-teal-400 mb-8 text-center">
                Step into Style
            </h2>
            <div id="shoes-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                <!-- Products will be dynamically loaded here -->
            </div>
        </section>

        <!-- Electronics Section -->
        <section id="electronics">
            <h2 class="text-3xl md:text-4xl font-bold text-teal-400 mb-8 text-center">
                Innovative Electronics
            </h2>
            <div id="electronics-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                <!-- Products will be dynamically loaded here -->
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-slate-900 text-white py-12">
        <div class="container mx-auto px-6 text-center">
            <div class="mb-4">
                <a href="#" class="text-white text-3xl font-bold">PAK Variety Store</a>
            </div>
            <p id="user-id-display" class="text-slate-400 text-sm mt-2"></p>
            <p class="text-slate-400">&copy; 2023 PAK Variety Store. All rights reserved.</p>
            <div class="mt-6 flex justify-center space-x-6 text-slate-400">
                <a href="#" class="hover:text-white transition duration-300">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M8.29 20.25a.75.75 0 01-.75-.75V11.25H6.5a.75.75 0 010-1.5h1.04v-1.29c0-1.74 1.4-3.15 3.14-3.15h1.96c.41 0 .75.34.75.75v1.23h-1.9c-.83 0-1.5.67-1.5 1.5v.96h2.25c.41 0 .75.34.75.75v.75h-2.25v8.5a.75.75 0 01-.75.75zM12 2a10 10 0 100 20 10 10 0 000-20zm0 18.5a8.5 8.5 0 110-17 8.5 8.5 0 010 17z" fill="currentColor"></path></svg>
                </a>
                <a href="#" class="hover:text-white transition duration-300">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zm0 18.5a8.5 8.5 0 110-17 8.5 8.5 0 010 17z" fill="currentColor"></path></svg>
                </a>
            </div>
        </div>
    </footer>
    
    <!-- Add to Cart Message Box -->
    <div id="message-box" class="message-box">Item added to cart!</div>
    
    <!-- Product Details Modal -->
    <div id="product-details-modal" class="modal">
        <div class="product-details-modal-content">
            <div class="flex justify-between items-center border-b border-slate-700 pb-3 mb-4">
                <h3 id="product-details-title" class="text-xl font-bold text-teal-400"></h3>
                <button id="close-details-modal" class="text-slate-400 hover:text-red-500 text-3xl font-semibold leading-none">&times;</button>
            </div>
            <div class="flex flex-col md:flex-row gap-6 items-center">
                <img id="product-details-image" src="" alt="" class="w-full md:w-1/2 rounded-lg object-cover">
                <div class="md:w-1/2">
                    <p id="product-details-price" class="text-2xl font-bold text-teal-400 mb-2"></p>
                    <p id="product-details-description" class="text-slate-300 text-sm mb-4"></p>
                    <button id="add-to-cart-details-btn" class="w-full bg-teal-500 text-white font-medium py-3 px-8 rounded-full hover:bg-teal-400 transition duration-300">
                        Add to Cart
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Shopping Cart Modal -->
    <div id="cart-modal" class="modal">
        <div class="cart-modal-content">
            <div class="flex justify-between items-center border-b border-slate-700 pb-3 mb-4">
                <h3 class="text-2xl font-bold text-teal-400">Shopping Cart</h3>
                <button id="close-cart-modal" class="text-slate-400 hover:text-red-500 text-3xl font-semibold leading-none">&times;</button>
            </div>
            <div id="cart-items-container" class="space-y-4">
                <!-- Cart items will be dynamically loaded here -->
            </div>
            <div class="mt-6 pt-4 border-t border-slate-700 flex justify-between items-center">
                <span class="text-xl font-bold">Total: $<span id="cart-total">0.00</span></span>
                <button id="checkout-btn" class="bg-teal-500 text-white font-semibold py-3 px-8 rounded-full hover:bg-teal-400 transition duration-300">
                    Checkout
                </button>
            </div>
        </div>
    </div>
    
    <!-- My Orders Modal -->
    <div id="orders-modal" class="modal">
        <div class="orders-modal-content">
            <div class="flex justify-between items-center border-b border-slate-700 pb-3 mb-4">
                <h3 class="text-2xl font-bold text-teal-400">My Orders</h3>
                <button id="close-orders-modal" class="text-slate-400 hover:text-red-500 text-3xl font-semibold leading-none">&times;</button>
            </div>
            <div id="orders-container" class="space-y-6">
                <!-- Orders will be dynamically loaded here -->
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, getDoc, deleteDoc, updateDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // Set Firebase debug log level
        setLogLevel('debug');

        // Global variables for Firebase configuration
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId;

        const defaultProducts = [
            { id: '1', name: 'Premium Hoodie', price: 69.99, image: 'https://placehold.co/400x400/2D3748/A0AEC0?text=Premium+Hoodie', category: 'clothes', description: '', timestamp: Date.now() + 1 },
            { id: '2', name: 'Stylish Joggers', price: 49.99, image: 'https://placehold.co/400x400/2D3748/A0AEC0?text=Stylish+Joggers', category: 'clothes', description: '', timestamp: Date.now() + 2 },
            { id: '3', name: 'Graphic T-Shirt', price: 29.99, image: 'https://placehold.co/400x400/2D3748/A0AEC0?text=Graphic+T-Shirt', category: 'clothes', description: '', timestamp: Date.now() + 3 },
            { id: '4', name: 'High-Top Sneakers', price: 89.99, image: 'https://placehold.co/400x400/2D3748/A0AEC0?text=High-Top+Sneakers', category: 'shoes', description: '', timestamp: Date.now() + 4 },
            { id: '5', name: 'Leather Loafers', price: 119.99, image: 'https://placehold.co/400x400/2D3748/A0AEC0?text=Leather+Loafers', category: 'shoes', description: '', timestamp: Date.now() + 5 },
            { id: '6', name: 'Running Shoes', price: 99.99, image: 'https://placehold.co/400x400/2D3748/A0AEC0?text=Running+Shoes', category: 'shoes', description: '', timestamp: Date.now() + 6 },
            { id: '7', name: 'Smart Watch', price: 199.99, image: 'https://placehold.co/400x400/2D3748/A0AEC0?text=Smart+Watch', category: 'electronics', description: '', timestamp: Date.now() + 7 },
            { id: '8', name: 'Wireless Headphones', price: 149.99, image: 'https://placehold.co/400x400/2D3748/A0AEC0?text=Wireless+Headphones', category: 'electronics', description: '', timestamp: Date.now() + 8 },
            { id: '9', name: 'Portable Speaker', price: 79.99, image: 'https://placehold.co/400x400/2D3748/A0AEC0?text=Portable+Speaker', category: 'electronics', description: '', timestamp: Date.now() + 9 },
        ];

        // Function to handle success messages
        const showMessage = (message) => {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.style.opacity = '1';
            setTimeout(() => {
                messageBox.style.opacity = '0';
            }, 3000);
        };

        const renderProducts = (products) => {
            const clothesGrid = document.getElementById('clothes-grid');
            const shoesGrid = document.getElementById('shoes-grid');
            const electronicsGrid = document.getElementById('electronics-grid');
            clothesGrid.innerHTML = '';
            shoesGrid.innerHTML = '';
            electronicsGrid.innerHTML = '';

            const isAdmin = !document.getElementById('admin-panel').classList.contains('hidden');

            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.classList.add('product-card', 'p-6', 'transition-transform', 'transform', 'hover:scale-105', 'cursor-pointer');
                productCard.dataset.id = product.id;
                
                let adminButtonsHtml = '';
                if (isAdmin) {
                    adminButtonsHtml = `
                        <button class="generate-description-btn w-full bg-fuchsia-500 text-white font-medium py-2 px-6 rounded-full hover:bg-fuchsia-400 transition duration-300" data-id="${product.id}" data-name="${product.name}" data-category="${product.category}">✨ Generate Description</button>
                        <button class="delete-btn w-full bg-red-500 text-white font-medium py-2 px-6 rounded-full hover:bg-red-400 transition duration-300" data-id="${product.id}">Delete</button>
                    `;
                }

                productCard.innerHTML = `
                    <img class="w-full h-64 object-cover object-center rounded-lg mb-4" src="${product.image}" alt="${product.name}" onerror="this.onerror=null; this.src='https://placehold.co/400x400/E5E7EB/1F2937?text=Image+Not+Found';">
                    <div class="flex flex-col items-center text-center">
                        <h3 class="text-lg font-semibold text-slate-100 mb-1">${product.name}</h3>
                        <p class="text-slate-400 mb-3">$${parseFloat(product.price).toFixed(2)}</p>
                        <div class="flex flex-col space-y-2 mt-4">
                            <button class="view-details-btn w-full bg-teal-500 text-white font-medium py-2 px-6 rounded-full hover:bg-teal-400 transition duration-300" data-id="${product.id}" data-name="${product.name}">View Details</button>
                            <button class="add-to-cart-btn w-full bg-slate-700 text-slate-300 font-medium py-2 px-6 rounded-full hover:bg-slate-600 transition duration-300" data-id="${product.id}">Add to Cart</button>
                            ${adminButtonsHtml}
                        </div>
                    </div>
                `;

                if (product.category === 'clothes') {
                    clothesGrid.appendChild(productCard);
                } else if (product.category === 'shoes') {
                    shoesGrid.appendChild(productCard);
                } else if (product.category === 'electronics') {
                    electronicsGrid.appendChild(productCard);
                }
            });
        };

        const renderCartItems = (cartItems) => {
            const cartItemsContainer = document.getElementById('cart-items-container');
            const cartTotalSpan = document.getElementById('cart-total');
            const cartCountSpan = document.getElementById('cart-count');
            cartItemsContainer.innerHTML = '';
            let total = 0;
            let totalItems = 0;

            if (cartItems.length === 0) {
                cartItemsContainer.innerHTML = '<p class="text-center text-slate-400">Your cart is empty.</p>';
            } else {
                cartItems.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.classList.add('flex', 'justify-between', 'items-center', 'bg-slate-700', 'p-4', 'rounded-lg');
                    itemElement.innerHTML = `
                        <div class="flex items-center space-x-4">
                            <img src="${item.image}" alt="${item.name}" class="w-16 h-16 rounded-lg object-cover">
                            <div>
                                <h4 class="font-semibold text-lg">${item.name}</h4>
                                <p class="text-slate-400">$${parseFloat(item.price).toFixed(2)} x ${item.quantity}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="update-quantity-btn bg-slate-600 text-white w-8 h-8 rounded-full hover:bg-slate-500" data-id="${item.id}" data-quantity="${item.quantity - 1}">-</button>
                            <span class="text-xl font-bold">${item.quantity}</span>
                            <button class="update-quantity-btn bg-slate-600 text-white w-8 h-8 rounded-full hover:bg-slate-500" data-id="${item.id}" data-quantity="${item.quantity + 1}">+</button>
                            <button class="remove-from-cart-btn bg-red-500 text-white w-8 h-8 rounded-full hover:bg-red-400" data-id="${item.id}">&times;</button>
                        </div>
                    `;
                    cartItemsContainer.appendChild(itemElement);
                    total += item.price * item.quantity;
                    totalItems += item.quantity;
                });
            }
            cartTotalSpan.textContent = total.toFixed(2);
            cartCountSpan.textContent = totalItems;
        };
        
        const renderOrders = (orders) => {
            const ordersContainer = document.getElementById('orders-container');
            ordersContainer.innerHTML = '';

            if (orders.length === 0) {
                ordersContainer.innerHTML = '<p class="text-center text-slate-400">You have no past orders.</p>';
            } else {
                orders.forEach(order => {
                    let orderTotal = 0;
                    const orderDate = new Date(order.timestamp).toLocaleString();
                    let itemsHtml = order.items.map(item => {
                        orderTotal += item.price * item.quantity;
                        return `
                            <div class="flex items-center space-x-4">
                                <img src="${item.image}" alt="${item.name}" class="w-12 h-12 rounded-lg object-cover">
                                <div>
                                    <h4 class="font-semibold">${item.name}</h4>
                                    <p class="text-slate-400 text-sm">$${parseFloat(item.price).toFixed(2)} x ${item.quantity}</p>
                                </div>
                            </div>
                        `;
                    }).join('');

                    const orderElement = document.createElement('div');
                    orderElement.classList.add('bg-slate-700', 'p-4', 'rounded-lg', 'space-y-4');
                    orderElement.innerHTML = `
                        <div class="flex justify-between items-center border-b border-slate-600 pb-2">
                            <h4 class="font-bold text-lg">Order ID: <span class="font-normal text-sm">${order.id.substring(0, 8)}...</span></h4>
                            <p class="text-sm text-slate-400">${orderDate}</p>
                        </div>
                        <div class="space-y-2">
                            ${itemsHtml}
                        </div>
                        <div class="flex justify-between items-center pt-2 border-t border-slate-600">
                            <span class="text-md font-bold">Order Total: $${orderTotal.toFixed(2)}</span>
                            <button class="cancel-order-btn bg-red-500 text-white font-semibold py-2 px-4 rounded-full hover:bg-red-400 transition duration-300" data-id="${order.id}">Cancel Order</button>
                        </div>
                    `;
                    ordersContainer.appendChild(orderElement);
                });
            }
        };

        const openProductDetailsModal = (product) => {
            const modal = document.getElementById('product-details-modal');
            document.getElementById('product-details-title').textContent = product.name;
            document.getElementById('product-details-image').src = product.image;
            document.getElementById('product-details-price').textContent = `$${parseFloat(product.price).toFixed(2)}`;
            document.getElementById('product-details-description').textContent = product.description || 'Description not available. Click "Generate Description" to create one!';
            
            const addToCartBtn = document.getElementById('add-to-cart-details-btn');
            addToCartBtn.dataset.id = product.id;
            addToCartBtn.dataset.name = product.name;
            addToCartBtn.dataset.price = product.price;
            addToCartBtn.dataset.image = product.image;

            modal.style.display = 'flex';
        };

        const generateAndSaveDescription = async (productId, productName, productCategory) => {
            const modal = document.getElementById('product-details-modal');
            const descriptionContent = document.getElementById('product-details-description');
            
            descriptionContent.innerHTML = `
                <div class="flex justify-center items-center">
                    <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>Generating description...</span>
                </div>
            `;
            modal.style.display = 'flex';

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const prompt = `Write a short, engaging, and creative marketing description for a product named '${productName}' in the '${productCategory}' category. Focus on style, quality, and consumer appeal. Do not include the product name in the description. Do not use quotes.`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text || "Description could not be generated.";
                
                // Save the generated description to Firestore
                await updateDoc(doc(db, `/artifacts/${appId}/users/${userId}/products`, productId), {
                    description: generatedText
                });

                descriptionContent.textContent = generatedText;
                showMessage('Description generated and saved!');

            } catch (error) {
                console.error("Error generating description:", error);
                descriptionContent.textContent = "Sorry, something went wrong. Please try again.";
            }
        };

        const setupEventListeners = () => {
            const adminPanel = document.getElementById('admin-panel');
            const adminToggleBtn = document.getElementById('admin-toggle');
            const viewOrdersToggleBtn = document.getElementById('view-orders-toggle');
            const addProductForm = document.getElementById('add-product-form');
            const cartToggleBtn = document.getElementById('cart-toggle');
            const checkoutBtn = document.getElementById('checkout-btn');
            const cartModal = document.getElementById('cart-modal');
            const closeCartModalBtn = document.getElementById('close-cart-modal');
            const ordersModal = document.getElementById('orders-modal');
            const closeOrdersModalBtn = document.getElementById('close-orders-modal');
            const productDetailsModal = document.getElementById('product-details-modal');
            const closeDetailsModalBtn = document.getElementById('close-details-modal');

            // Toggle Admin Panel visibility and admin buttons on product cards
            adminToggleBtn.addEventListener('click', () => {
                adminPanel.classList.toggle('hidden');
                // Re-render products to show/hide admin buttons
                const productsRef = collection(db, `/artifacts/${appId}/users/${userId}/products`);
                onSnapshot(productsRef, (snapshot) => {
                    const products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    products.sort((a, b) => a.timestamp - b.timestamp);
                    renderProducts(products);
                });
            });

            // Toggle Cart Modal visibility
            cartToggleBtn.addEventListener('click', () => {
                cartModal.style.display = 'flex';
            });

            // Toggle Orders Modal visibility
            viewOrdersToggleBtn.addEventListener('click', () => {
                ordersModal.style.display = 'flex';
            });

            // Close modals
            closeCartModalBtn.addEventListener('click', () => {
                cartModal.style.display = 'none';
            });
            closeOrdersModalBtn.addEventListener('click', () => {
                ordersModal.style.display = 'none';
            });
            closeDetailsModalBtn.addEventListener('click', () => {
                productDetailsModal.style.display = 'none';
            });

            window.addEventListener('click', (event) => {
                if (event.target === cartModal) {
                    cartModal.style.display = 'none';
                }
                if (event.target === productDetailsModal) {
                    productDetailsModal.style.display = 'none';
                }
                if (event.target === ordersModal) {
                    ordersModal.style.display = 'none';
                }
            });

            // Handle adding new products to Firestore
            addProductForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const name = document.getElementById('product-name').value;
                const price = document.getElementById('product-price').value;
                const image = document.getElementById('product-image').value;
                const category = document.getElementById('product-category').value;

                try {
                    await addDoc(collection(db, `/artifacts/${appId}/users/${userId}/products`), {
                        name,
                        price: parseFloat(price),
                        image,
                        category,
                        description: '',
                        timestamp: Date.now()
                    });
                    showMessage('Product added successfully!');
                    addProductForm.reset();
                } catch (e) {
                    console.error("Error adding document: ", e);
                    showMessage('Error adding product.');
                }
            });

            // Handle Clicks on product cards and buttons
            document.addEventListener('click', async (event) => {
                const target = event.target;

                // Handle product card click to open details modal
                if (target.closest('.product-card') || target.classList.contains('view-details-btn')) {
                    const productId = target.closest('.product-card')?.dataset.id || target.dataset.id;
                    if (!productId) return;
                    
                    const productsRef = collection(db, `/artifacts/${appId}/users/${userId}/products`);
                    const querySnapshot = await getDocs(productsRef);
                    const products = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const product = products.find(p => p.id === productId);
                    if (product) {
                        openProductDetailsModal(product);
                    }
                }

                // Handle add to cart button click
                if (target.classList.contains('add-to-cart-btn') || target.id === 'add-to-cart-details-btn') {
                    const productId = target.dataset.id;
                    const productsRef = collection(db, `/artifacts/${appId}/users/${userId}/products`);
                    const querySnapshot = await getDocs(productsRef);
                    const product = querySnapshot.docs.find(doc => doc.id === productId)?.data();

                    if (!product) {
                        console.error("Product not found!");
                        return;
                    }

                    const cartItemRef = doc(db, `/artifacts/${appId}/users/${userId}/cart`, productId);
                    const cartItemDoc = await getDoc(cartItemRef);
                    
                    if (cartItemDoc.exists()) {
                        await updateDoc(cartItemRef, {
                            quantity: cartItemDoc.data().quantity + 1
                        });
                    } else {
                        await setDoc(cartItemRef, {
                            name: product.name,
                            price: product.price,
                            image: product.image,
                            quantity: 1
                        });
                    }
                    showMessage('Item added to cart!');
                    productDetailsModal.style.display = 'none';
                }
                
                // Handle update quantity buttons
                if (target.classList.contains('update-quantity-btn')) {
                    const productId = target.dataset.id;
                    const newQuantity = parseInt(target.dataset.quantity);
                    if (newQuantity > 0) {
                         await updateDoc(doc(db, `/artifacts/${appId}/users/${userId}/cart`, productId), {
                            quantity: newQuantity
                        });
                    } else {
                         await deleteDoc(doc(db, `/artifacts/${appId}/users/${userId}/cart`, productId));
                    }
                }

                // Handle remove from cart button
                if (target.classList.contains('remove-from-cart-btn')) {
                    const productId = target.dataset.id;
                    await deleteDoc(doc(db, `/artifacts/${appId}/users/${userId}/cart`, productId));
                    showMessage('Item removed from cart.');
                }
                
                // Handle checkout button
                if (target.id === 'checkout-btn') {
                    const cartSnapshot = await getDocs(collection(db, `/artifacts/${appId}/users/${userId}/cart`));
                    if (cartSnapshot.empty) {
                        showMessage('Your cart is empty. Please add items before checking out.');
                        return;
                    }
                    const cartItems = cartSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    await addDoc(collection(db, `/artifacts/${appId}/users/${userId}/orders`), {
                        items: cartItems,
                        timestamp: Date.now()
                    });

                    // Clear the cart using a batch write for efficiency
                    const batch = writeBatch(db);
                    cartSnapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();

                    cartModal.style.display = 'none';
                    showMessage('Order placed successfully!');
                }

                // Handle cancel order button
                if (target.classList.contains('cancel-order-btn')) {
                    const orderId = target.dataset.id;
                    try {
                        await deleteDoc(doc(db, `/artifacts/${appId}/users/${userId}/orders`, orderId));
                        showMessage('Order canceled successfully!');
                    } catch (e) {
                        console.error("Error canceling order: ", e);
                        showMessage('Error canceling order.');
                    }
                }
                
                // Handle delete button (Admin Feature)
                if (target.classList.contains('delete-btn')) {
                    const productId = target.dataset.id;
                    try {
                        await deleteDoc(doc(db, `/artifacts/${appId}/users/${userId}/products`, productId));
                        showMessage('Product deleted successfully!');
                    } catch (e) {
                        console.error("Error deleting document: ", e);
                        showMessage('Error deleting product.');
                    }
                }

                // Handle generate description button (Admin Feature)
                if (target.classList.contains('generate-description-btn')) {
                    const productId = target.dataset.id;
                    const productName = target.dataset.name;
                    const productCategory = target.dataset.category;
                    generateAndSaveDescription(productId, productName, productCategory);
                }
            });
        };

        const setupFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                userId = auth.currentUser?.uid;
                if (!userId) {
                    console.error("Failed to get user ID.");
                    return;
                }
                document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                
                const productsCollectionRef = collection(db, `/artifacts/${appId}/users/${userId}/products`);
                const snapshot = await getDocs(productsCollectionRef);
                if (snapshot.empty) {
                    for (const product of defaultProducts) {
                        await addDoc(productsCollectionRef, product);
                    }
                    console.log("Default products added to Firestore.");
                }

                onSnapshot(productsCollectionRef, (snapshot) => {
                    const products = [];
                    snapshot.forEach(doc => {
                        products.push({ id: doc.id, ...doc.data() });
                    });
                    products.sort((a, b) => a.timestamp - b.timestamp);
                    renderProducts(products);
                }, (error) => {
                    console.error("Error fetching products: ", error);
                    showMessage('Error fetching products. Please check the console.');
                });
                
                onSnapshot(collection(db, `/artifacts/${appId}/users/${userId}/cart`), (snapshot) => {
                    const cartItems = [];
                    snapshot.forEach(doc => {
                        cartItems.push({ id: doc.id, ...doc.data() });
                    });
                    renderCartItems(cartItems);
                }, (error) => {
                    console.error("Error fetching cart: ", error);
                    showMessage('Error fetching cart. Please check the console.');
                });

                onSnapshot(collection(db, `/artifacts/${appId}/users/${userId}/orders`), (snapshot) => {
                    const orders = [];
                    snapshot.forEach(doc => {
                        orders.push({ id: doc.id, ...doc.data() });
                    });
                    orders.sort((a, b) => b.timestamp - a.timestamp); // Sort by newest first
                    renderOrders(orders);
                }, (error) => {
                    console.error("Error fetching orders: ", error);
                    showMessage('Error fetching orders. Please check the console.');
                });

                setupEventListeners();
                
            } catch (e) {
                console.error("Firebase setup error: ", e);
                showMessage('Firebase initialization failed. Check the console for details.');
            }
        };

        document.addEventListener('DOMContentLoaded', setupFirebase);
    </script>

</body>
</html>
